# CardForge: Idle Spire — План разработки прототипа

## 0. Ключевое решение: платформа прототипа

### Рекомендация: Web-прототип (TypeScript + React)

**Почему НЕ Godot/Unity на этапе прототипа:**
- Claude Code работает в терминале → отлично генерирует код, но не может запускать GUI-приложения Godot/Unity и видеть результат
- Баги в визуальном движке сложно дебажить без визуального превью
- 80% ценности прототипа — в логике (бои, AI, экономика), а не в графике
- Перенос чистой логики в движок потом — тривиально (архитектура ECS/MVC)

**Почему Web:**
- Мгновенный визуальный результат в браузере
- React-компоненты отлично ложатся на UI-экраны из GDD (§17)
- TypeScript = типизация = меньше багов в формулах
- Можно дать плейтестерам ссылку без установки
- Логика на TS легко портируется в Godot (GDScript) или Unity (C#)

**Scope прототипа:** Полностью играбельный core loop в браузере — сборка колоды, AI-правила, бои с визуализацией, крафт, prestige, симулятор. Без звука, с минимальным UI (Tailwind + иконки).

---

## 1. Что нужно додизайнить ДО написания кода

GDD v5.0 очень хорош, но для реализации не хватает конкретных данных. Ниже — чёткий список с шаблонами, которые нужно заполнить.

### 1.1 Враги Крипты (10 типов) — КРИТИЧНО

GDD §6: «10 типов врагов», но ни один не описан.

**Шаблон для каждого врага:**

```
Имя: [название]
Тип: Обычный / Элита / Босс
Base HP: [число]
Base ATK: [число]
Паттерн поведения (цикл намерений):
  Ход 1: [Атака / Защита / Бафф / Дебафф] — [эффект]
  Ход 2: ...
  (повтор цикла)
Особенность: [уникальная механика, если есть]
Этажи появления: [1–3 / 4–7 / 8–10 / любой]
```

**Нужно заполнить:**
- 6 обычных врагов (по 2 на раннюю, среднюю, позднюю Крипту)
- 3 элиты (этажи 3, 6, 9)  
- 1 босс (этаж 10)

**Предложение — я могу сгенерировать всех 10 на основе GDD-формул, если одобришь подход:**
- Обычные: простые паттерны 2–3 хода, тематика нежити (Крипта)
- Элиты: 3–4 хода, уникальные механики (воскрешение, AoE, бафф союзников)
- Босс: 2 фазы, 5–6 ходов в цикле, проверка всех архетипов

### 1.2 Полный пул из 50 карт MVP — КРИТИЧНО

GDD §15: «50 карт (30 обычных, 15 необычных, 5 редких)». Детально описаны 3 карты. Нужны 47.

**Шаблон для каждой карты:**

```
Имя: [название]
Редкость: Обычная(4PP) / Необычная(7PP) / Редкая(11PP)
Тип: Атака / Защита / Навык / Пассивка / Реакция / Генератор
Стоимость: [0–3 энергии]
Архетип: Берсерк / Ядовитый / Щитовик / Нейтральный
Keywords: [Яд, Горение, Торн, Рывок, Ритуал, Вампиризм, нет]
Эффект: [описание]
PP-распределение: [детальный расчёт]
Усиление +1/+2/+3: [числа]
```

**Предложение — структура пула:**

| Архетип | Обычные | Необычные | Редкие | Итого |
|---------|---------|-----------|--------|-------|
| Берсерк | 6 | 3 | 1 | 10 |
| Ядовитый | 6 | 3 | 1 | 10 |
| Щитовик | 6 | 3 | 1 | 10 |
| Нейтральные | 12 | 6 | 2 | 20 |
| **Итого** | **30** | **15** | **5** | **50** |

Нейтральные = карты, полезные для любого архетипа (базовые атаки, хилы, универсальная защита).

**Я могу сгенерировать все 50 карт с PP-расчётами**, если подтвердишь структуру.

### 1.3 Босс Крипты — детальный дизайн

```
Имя: [например, «Некролорд» / «Вечный Страж»]
HP: base_hp × 3.5 (по формуле §4.1, на этаже 10)
Фаза 1 (HP > 50%): паттерн ходов [описать]
Фаза 2 (HP ≤ 50%): паттерн ходов [описать]
Особая механика: [что делает босса уникальным]
Проверяемые навыки: [какие архетипы он тестирует]
```

### 1.4 События подземелья

GDD §6.1: на карте маршрута есть «Событие», но механика не описана.

**Минимум для MVP — 5 типов событий:**

```
Событие: [название]
Описание: [что видит игрок]
Выборы:
  A) [действие] → [результат]
  B) [действие] → [результат]
  C) Уйти → ничего
```

Примеры для дизайна:
1. «Алтарь» — пожертвовать HP за карту
2. «Торговец» — купить карту за золото
3. «Проклятый сундук» — бесплатная карта, но дебафф
4. «Тренировочный манекен» — усилить карту за осколки
5. «Странник» — выбор: хил или золото

### 1.5 Магазин подземелья

Минимальная спецификация:
- Сколько карт в ассортименте? (предложение: 3 случайных + 1 удаление карты)
- Цены? (предложение: 50/100/200 золота по редкости)
- Обновляется ли ассортимент?
- Можно ли продавать карты?

### 1.6 Карты-генераторы

Тип «Генератор» описан в §4.2, но ни одна конкретная карта не прописана.
Для MVP нужно минимум 3 генератора в пуле из 50.

```
Имя: [например, «Золотой жук»]
Редкость: [...]
Эффект idle: [X золота/мин, Y осколков/мин]
Деградация: −10%/день (по §8.6)
```

---

## 2. Архитектура данных (JSON-схемы)

Это нужно формализовать до кода — определяет всю структуру.

### 2.1 Карта (Card)

```typescript
interface Card {
  id: string;                    // "poisoned_blade"
  name: string;                  // "Отравленный клинок"
  nameEn: string;                // "Poisoned Blade"
  rarity: 'common' | 'uncommon' | 'rare' | 'epic' | 'legendary';
  type: 'attack' | 'defense' | 'skill' | 'passive' | 'reaction' | 'generator';
  cost: number;                  // энергия (0–3)
  powerBudget: number;           // PP
  archetype: 'berserker' | 'poison' | 'shield' | 'tempo' | 'generator' | 'neutral';
  keywords: string[];            // ["poison", "weakness"]
  effects: CardEffect[];         // структурированные эффекты
  upgrade: {                     // значения для +1, +2, +3
    1: Partial<CardEffect[]>;
    2: Partial<CardEffect[]>;
    3: Partial<CardEffect[]>;
  };
  lore?: string;                 // текст для каталога
}

interface CardEffect {
  type: 'damage' | 'block' | 'heal' | 'poison' | 'burn' | 'thorn' 
      | 'weakness' | 'vulnerability' | 'str' | 'dex' | 'draw' | 'energy'
      | 'damage_aoe' | 'gold_per_min' | 'shards_per_min';
  value: number;
  target?: 'self' | 'enemy' | 'all_enemies' | 'strongest' | 'weakest';
  condition?: string;            // "block > 20" для условных эффектов
}
```

### 2.2 Враг (Enemy)

```typescript
interface Enemy {
  id: string;
  name: string;
  type: 'normal' | 'elite' | 'boss';
  baseHp: number;
  baseAtk: number;
  pattern: EnemyIntent[];        // циклический паттерн поведения
  special?: string;              // уникальная механика
  floors: [number, number];      // диапазон этажей появления
}

interface EnemyIntent {
  type: 'attack' | 'defend' | 'buff' | 'debuff' | 'attack_defend' | 'summon';
  value: number;
  effect?: string;               // доп. эффект ("poison:2", "strength:1")
}
```

### 2.3 AI-правило (AIRule)

```typescript
interface AIRule {
  priority: number;              // 1–10
  condition: {
    parameter: 'hp' | 'hp_percent' | 'block' | 'enemy_count' 
             | 'enemy_poison' | 'enemy_weakness' | 'enemy_hp'
             | 'energy' | 'always';
    operator: '<' | '>' | '<=' | '>=' | '=' | '!=';
    value: number;
  };
  cardId: string;                // какую карту играть
  target: 'self' | 'nearest' | 'strongest' | 'weakest' 
        | 'poisoned' | 'burning' | 'random' | 'all';
}
```

### 2.4 Состояние забега (RunState)

```typescript
interface RunState {
  floor: number;                 // текущий этаж (1–10)
  map: DungeonNode[][];          // процедурная карта
  construct: {
    hp: number;
    maxHp: number;
    block: number;
    energy: number;
    maxEnergy: number;
    str: number;
    dex: number;
    statuses: Map<string, number>;
  };
  deck: DeckCard[];              // карты в колоде с уровнями усиления
  hand: DeckCard[];
  drawPile: DeckCard[];
  discardPile: DeckCard[];
  exhaustPile: DeckCard[];
  aiRules: AIRule[];
  gold: number;
  rewards: Reward[];
  battleLog: LogEntry[];
}
```

### 2.5 Сохранение (SaveData)

```typescript
interface SaveData {
  version: string;
  prestigeLevel: number;
  foil: number;
  eternalCards: string[];        // ID вечных карт
  blueprintsUnlocked: string[];
  achievementsCompleted: string[];
  aiConditionsUnlocked: string[];
  workshop: {
    anvil: number;               // уровень наковальни
    library: number;
    portal: number;
  };
  library: OwnedCard[];          // все карты игрока
  gold: number;
  shards: number;
  activeExpedition?: RunState;
  offlineTimestamp?: number;     // для idle-расчёта
  stats: PlayerStats;
}
```

---

## 3. Порядок разработки (фазы)

### Фаза 0: Инфраструктура (2–3 часа)
```
[ ] Инициализация проекта: Vite + React + TypeScript + Tailwind
[ ] Структура папок: /src/models, /src/engine, /src/components, /src/data
[ ] JSON-файлы данных: cards.json, enemies.json, dungeons.json
[ ] Утилиты: random с сидом, форматирование чисел
[ ] Простой state management (Zustand или React Context)
```

### Фаза 1: Боевой движок (4–6 часов) — ЯДРО
```
[ ] BattleEngine: пошаговая симуляция боя
    - Инициализация: конструкт vs враг(и)
    - Цикл хода: тянуть карты → AI выбирает карту → применить эффекты → ход врага
    - Система статусов: яд (тик + декремент), слабость, уязвимость, торн
    - Система энергии: 3/ход, карты тратят энергию
    - Условие победы/поражения
[ ] AIEngine: парсинг и выполнение правил
    - Проход по правилам сверху вниз
    - Проверка условий (HP, блок, статусы врага, etc.)
    - Выбор цели
    - Повтор до исчерпания энергии
[ ] Симулятор: прогон 100 боёв → статистика (winrate, avg dmg, avg turns)
[ ] Тесты: 3 архетипа × 10 этажей → проверка winrate 50–65%
```

### Фаза 2: Визуализация боя (3–4 часа)
```
[ ] BattleScreen: React-компонент
    - Враги сверху (HP-бары, намерения, статусы)
    - Конструкт по центру (HP, блок, энергия, STR/DEX)
    - Рука внизу (карты)
    - Лог AI-решений (ключевой элемент из §17.4)
[ ] Пошаговая анимация: подсветка сыгранной карты, числа урона/блока
[ ] Скорость: ×1 / ×2 / ×4 / мгновенный результат
[ ] Пауза
```

### Фаза 3: Сборка колоды + AI-редактор (4–5 часов)
```
[ ] DeckBuilder: экран из §17.2
    - Текущая колода (drag & drop)
    - Библиотека с фильтрами (тип, редкость, keyword, архетип)
    - Индикатор баланса и архетипа
    - Тап на карту = подробное описание
[ ] AIEditor: экран из §17.3
    - Список правил (drag & drop для приоритета)
    - Dropdown-селекторы: условие, карта, цель
    - Кнопка «+», удаление, перемещение
    - Тест 10 боёв
[ ] Шаблоны колод: 3 предустановленных (§16.3)
```

### Фаза 4: Подземелье / забег (4–5 часов)
```
[ ] Процедурная генерация карты (как в StS):
    - 10 этажей, 3 пути на каждом разветвлении
    - Типы узлов: бой, элита, сундук, событие, магазин, отдых
    - Распределение: боссов — 1 (этаж 10), элит — 2–3, остальное — обычные
[ ] RunManager: управление забегом
    - Навигация по карте (выбор пути)
    - Авто-навигация: 5 стратегий из §6.2
    - Награды после боя: золото + карта (выбор из 3)
    - Смерть → экран результатов
    - Победа над боссом → доступ к Переплавке
[ ] События (5 штук, минимальные)
[ ] Магазин (3 карты + удаление)
[ ] Отдых (хил 30% HP)
```

### Фаза 5: Мастерская + Крафт (3–4 часа)
```
[ ] WorkshopScreen: экран из §17.1
    - 3 станка: Наковальня, Библиотека, Портал
    - Уровни станков, стоимость улучшения (формула §A.4)
    - Валюты вверху (золото, осколки)
[ ] Крафт (§4.5):
    - Усиление: карта + дубликат → карта+1
    - Переплав: 3 карты одной редкости → 1 выше
    - Разбор: карта → осколки
[ ] Библиотека: все имеющиеся карты, фильтры, сортировка
[ ] Портал: запуск забега, выбор подземелья (пока только Крипта)
```

### Фаза 6: Экономика + Idle (3–4 часа)
```
[ ] Формулы наград (§A.5): gold, card drop, shards
[ ] Income/drain tracking: отслеживание золота/час
[ ] Генераторы: idle-ресурсы с деградацией (§8.6)
[ ] Офлайн-расчёт (§18.2):
    - При закрытии → сохранить timestamp
    - При открытии → delta_time, упрощённая симуляция
    - Экран «Результаты пока вас не было»
[ ] Деградация генераторов: −10%/день
```

### Фаза 7: Prestige — Переплавка (2–3 часа)
```
[ ] Формула фольги (§A.6)
[ ] Сброс: карты, золото, станки, прогресс
[ ] Сохранение: фольга, вечная карта, чертежи, знания AI
[ ] Экран Переплавки: показать, что получишь / что потеряешь
[ ] Траты фольги: +5 HP, +1 золото/бой, слот экспедиции
[ ] Проверка: 2-й цикл ≥ 40% быстрее 1-го
```

### Фаза 8: Онбординг (2–3 часа)
```
[ ] Обучающий мини-забег (3 этажа, ослабленные враги)
[ ] Предсобранная колода «Стартер» с 3 AI-правилами
[ ] Подсказки-выноски по сценарию §16.2
[ ] Прогресс-бар обучения (7 чекпоинтов)
[ ] Первая замена карты + первое AI-правило
```

### Фаза 9: Симулятор + QoL (2–3 часа)
```
[ ] Полный симулятор 100 боёв с визуализацией результатов
[ ] Статистика колоды: % использования карт, среднее dmg/block
[ ] Быстрый перезапуск
[ ] Сравнение карт (side-by-side)
[ ] Экспорт/импорт колод (строка-код)
[ ] Авто-сохранение
```

---

## 4. Оценка трудозатрат

| Фаза | Часы (Claude Code) | Описание |
|------|-------------------|----------|
| 0. Инфраструктура | 2–3 ч | Проект, структура, утилиты |
| 1. Боевой движок | 4–6 ч | Ядро всей игры |
| 2. Визуализация боя | 3–4 ч | React-компоненты |
| 3. Колода + AI-редактор | 4–5 ч | Два ключевых экрана |
| 4. Подземелье | 4–5 ч | Карта, забег, события |
| 5. Мастерская + крафт | 3–4 ч | Hub, станки, рецепты |
| 6. Экономика + idle | 3–4 ч | Формулы, офлайн |
| 7. Prestige | 2–3 ч | Переплавка |
| 8. Онбординг | 2–3 ч | Туториал |
| 9. QoL + симулятор | 2–3 ч | Полировка |
| **Итого** | **~30–40 ч** | **Сессий Claude Code** |

**Реалистичный срок:** 2–3 недели при работе по 2–3 часа/день с Claude Code.

---

## 5. Что Claude Code может и не может

### ✅ Отлично справится:
- Вся игровая логика (TypeScript) — бои, AI, экономика, крафт
- React-компоненты UI — экраны из §17
- Балансные формулы — прямая реализация из Приложения A
- Генерация данных — 50 карт, 10 врагов по шаблонам и PP-формулам
- Симулятор — прогон тысяч боёв, статистика
- State management — сохранения, idle-расчёт
- Тесты — проверка winrate архетипов, экономических формул

### ⚠️ Ограниченно:
- Визуальные анимации — базовые CSS-анимации да, сложные — нет
- Drag & drop — библиотеки (dnd-kit) работают, но тюнинг по ощущениям нужен вручную
- Мобильная адаптация — responsive layout да, но тестирование на устройствах — вручную

### ❌ Не сможет:
- Арт: иллюстрации карт, спрайты врагов, UI-элементы в стиле «тёплый стимпанк»
- Звук / музыка
- Тестирование «фана» — это только плейтесты с людьми
- Steam-интеграция (achievements, cloud saves) — это уже этап движка

---

## 6. Рекомендуемый порядок действий

### Шаг 1 — Сейчас: Утвердить контент
Решить открытые вопросы из раздела 1:
1. ✍️ **Подтвердить структуру 50 карт** (таблица в §1.2) → я генерирую все 50 с PP
2. ✍️ **Подтвердить подход к врагам** (§1.1) → я генерирую 10 врагов
3. ✍️ **Решить про события и магазин** (§1.4, §1.5) → я дизайню по предложениям
4. ✍️ **Выбрать технологию**: Web (TypeScript/React) или Godot?

### Шаг 2 — После утверждения: Генерация данных
Claude Code генерирует:
- `cards.json` — 50 карт с полным PP-расчётом
- `enemies.json` — 10 врагов с паттернами
- `events.json` — 5 событий
- Всё по формулам из GDD

### Шаг 3 — Кодинг по фазам
Фаза 1 → ... → Фаза 9, по порядку.
Каждая фаза = отдельная сессия Claude Code.

### Шаг 4 — Плейтест
Прогнать валидационные вопросы из §21.3 и §25 (OQ1–OQ10) на рабочем прототипе.

---

## 7. Открытые вопросы к тебе

1. **Web или Godot?** Рекомендую web для прототипа — быстрее, удобнее для Claude Code, можно дать плейтестерам ссылку. Godot — для продакшн-версии потом.

2. **Язык интерфейса прототипа?** Только RU, только EN, или оба? Для скорости — один язык.

3. **Генерировать 50 карт и 10 врагов?** Если да — я сделаю это первым шагом, ты ревьюишь баланс, потом кодим.

4. **Scope онбординга в прототипе:** Полный сценарий из §16.2 или упрощённый (просто стартовая колода + тултипы)?

5. **Idle в прототипе — реальный или имитация?** Реальный (localStorage + timestamp) или кнопка «Симулировать 8 часов»?
